<% if @order.errors.any? %>
  <div id="error_explanation">
    <h2><%= pluralize(@order.errors.count, "error") %> prohibited this order from being saved:</h2>
    <ul>
    <% @order.errors.full_messages.each do |message| %>
      <li><%= message %></li>
    <% end %>
    </ul>
  </div>
<% end %>

<div class="mb-1  ml-2 mt-2 text-left">
    <button class="inline-flex items-center  px-1 py-1  bg-transparent hover:bg-slate-300 text-black text-sm font-medium rounded-md border border-black hover:scale-110 transition duration-200" onclick="history.back()">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
      </svg>
      back
    </button>
  </div>

<%= form_with(url: warehouse_storage_path(@order), method: "get", local: true) do |f| %>
  <div id="system-container">
    <%= f.collection_select :system_id, System.all, :id, :name, {selected: @selected_system&.id, prompt: 'System'}, {id: 'system_select', onchange: 'showCategories()', class: "w-32"} %>
  </div>

  <div id="category-container" style="display:none;">
    <%= f.collection_select :category_id, Category.all, :id, :name, {selected: @selected_category&.id, prompt: 'Category'}, {id: 'category_select', onchange: 'showParts()', class: "w-32"} %>
  </div>
<% end %>

<%= form_with(url: add_part_order_path(@order), method: "post", local: true) do |f| %>
  <%= hidden_field_tag :system_id, @selected_system&.id %>
  <%= hidden_field_tag :category_id, @selected_category&.id %>
  <div id="part-container" style="display:none;">
    <%= f.collection_select :part_id, @parts, :id, :name_with_description, prompt: 'Part' %>
    <%= f.label :quantity, "Quantity:" %>
    <%= f.number_field :quantity %>
    <%= f.submit "Add" %>
  </div>
<% end %>




<h1 class="text-lg text-center">Order Details</h1>
<div> <div class= "flex inline justify-end">
      <div data-controller="lightbox">
        <%= link_to asset_path('instruction_show.png'), data: { lightbox: 'instruction', title: 'Instruction' } do %>
          <div class= "flex inline">
          <%= image_tag('instruction_img.png', size: '20x20', class: 'inline mr-1') %>
          <%= button_to " Instruction", class: "your-button-classes ml-2" %>
          </div>
        <% end %>
      </div>
    </div>
  <p>Scaffolder: <%= @order.user.name %> <%= @order.user.email %></p>
  <p class="text-lg">Building Site: <%= @order.building_site %></p>
  <p>Site info: <%= @order.building_site_info %></p>
  <p class="text-lg">Delivery Date: <%= @order.delivery_date.strftime("%d-%m-%Y") %></p>
  <p><strong>Additional Parts/Info: </strong> <%= simple_format(@order.info) %></p>
</div>

<h2 class="mt-10">Ordered Parts:</h2>
<% total_weight = 0 %>
<%= form_with(model: @order, url: warehouse_storage_path(@order), method: :patch) do |form| %>
  <% @order.order_lists.includes(:part).sort_by { |ol| ol.description.downcase }.each_with_index do |order_list, index| %>
    <%= form.fields_for :order_lists, order_list do |order_list_form| %>
      <div class="m-2 ml-1 border-b-2 flex inline">
        <p class="text-lg pt-2 mb-6"> <%= order_list_form.check_box :checkbox, class: "w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 dark:focus:ring-green-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" %> <strong><%= index + 1 %>. <%= order_list.part.name if order_list.part %></strong>/<%= order_list.description %>-- </p><p class="text-lg text-indigo-800 pt-2"><strong><%= order_list.quantity %></strong> stk/</p><p class="text-sm"><%= order_list_form.number_field :delivery_quantity, value: (order_list.delivery_quantity), min: 0, class: ' text-green-800 w-20 text-lg', style: 'border: none;' %> stk for delivery</p>
        <% total_weight += order_list.quantity * order_list.weight %>
      </div>
    <% end %>
  
<% end %>


<h2 class="mt-10">Additional parts from Lagermann:</h2>
<% total_storage_weight = 0 %>
<%= form_with(model: @order, url: warehouse_storage_path(@order), method: :patch) do |form| %>
  <% @order.order_storage_lists.includes(:part).sort_by { |osl| osl.description.downcase }.each_with_index do |order_storage_list, index| %>
    <%= form.fields_for :order_storage_lists, order_storage_list do |order_storage_list_form| %>
      <div class="m-2 ml-1 border-b-2 flex inline">
        <p class="text-lg pt-2 mb-6"> <%= order_storage_list_form.check_box :checkbox, class: "w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 dark:focus:ring-green-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" %> <strong><%= index + 1 %>. <%= order_storage_list.part.name if order_storage_list.part %></strong>/<%= order_storage_list.description %>-- </p><p class="text-lg text-indigo-800 pt-2"><strong><%= order_storage_list.quantity %></strong> stk</p>

<%= link_to 'Delete', delete_part_order_path(@order, order_storage_list_id: order_storage_list.id), method: :delete, data: { confirm: 'Are you sure?' }, class: 'text-red-600' %>
        <% total_storage_weight += order_storage_list.quantity * order_storage_list.weight %>
      </div>
    <% end %>
  <% end %>
<% end %>


<p><strong>Additional Info:</strong> <%= simple_format(@order.info) %></p>
    <div class="mt-4">
      <p><%= form.label :storage_info, "Storage Parts/Delivery Info:", class: "mr-2 mt-2" %></p>
      <p><%= form.text_area :storage_info, value: (@order.storage_info || @order.info ), rows: 6, cols: 40 %></p>
    </div>

  <p class="text-center mt-4"><strong>Delivery Date wanted:</strong> <%= @order.delivery_date.strftime("%d-%m-%Y") %></p>
  <div class="mt-4 justify-center text-center">
    <%= form.label :new_delivery_date, "Change Delivery Date?" %>
    <%= form.date_field :new_delivery_date, min: Date.today, value: @order.new_delivery_date %>
  </div>
  <div class="flex justify-center mt-4">
    <%= form.label :car_number, "Delivery Car Number:", class: "mr-2 mt-2" %>
    <%= form.text_field :car_number, class: "w-32" %>
  </div>
  <div class="flex justify-center m-6">
    <%= form.submit "Save as In Progress", class: "inline-flex items-center px-4 py-2 bg-green-800 hover:bg-gray-700 text-white font-semibold rounded-md"%>
  </div>
<% end %>
<p class="text-center m-4"><strong>Total Weight:</strong> <%= total_weight %>kg</p>



<script>
function showCategories() {
  const selectedSystem = document.getElementById('system_select').value;
  if (selectedSystem) {
    document.getElementById('category-container').style.display = 'block';
  } else {
    document.getElementById('category-container').style.display = 'none';
    document.getElementById('part-container').style.display = 'none';
  }
}

function showParts() {
  const selectedCategory = document.getElementById('category_select').value;
  if (selectedCategory) {
    document.getElementById('part-container').style.display = 'block';
  } else {
    document.getElementById('part-container').style.display = 'none';
  }
}

</script>